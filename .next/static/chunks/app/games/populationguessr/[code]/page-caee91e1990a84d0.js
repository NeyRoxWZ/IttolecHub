(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[371],{1484:function(e,t,a){Promise.resolve().then(a.bind(a,4632))},4632:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return p}});var l=a(7437),n=a(2265),s=a(9313),r=a(4203),o=a(5192),i=a(1291),c=a(8748),d=a(2369),u=a(2442),m=a(6691),x=a.n(m);function f(e){var t,a,m;let{roomCode:f,settings:p}=e,[h,g]=(0,n.useState)(""),[v,b]=(0,n.useState)(30),[y,w]=(0,n.useState)(5),[j,N]=(0,n.useState)(30),[k,S]=(0,n.useState)(null),{roomStatus:E,players:I,gameState:_,isHost:C,playerId:M,updateSettings:T,startGame:L,submitAnswer:P,nextRound:R,updateRoundData:O,setGameStatus:z,updatePlayerScore:D}=(0,i.d)(null!=f?f:"","populationguessr"),{broadcast:q,messages:F}=(0,o.r)(null!=f?f:"","populationguessr"),A=sessionStorage.getItem("playerName")||"Anonyme",U="in_game"===E,Z=(null==_?void 0:_.status)==="round_results"||(null==_?void 0:_.status)==="game_over",B=(null==_?void 0:null===(t=_.round_data)||void 0===t?void 0:t.city)||null,G=(null==_?void 0:_.current_round)||0,H=(0,n.useMemo)(()=>I.reduce((e,t)=>({...e,[t.name]:t.score}),{}),[I]);(0,n.useEffect)(()=>{C&&p&&Object.keys(p).length>0&&T(p)},[C,p]),(0,n.useEffect)(()=>{(null==_?void 0:_.settings)&&(_.settings.rounds&&w(parseInt(_.settings.rounds,10)),_.settings.time&&N(parseInt(_.settings.time,10)))},[null==_?void 0:_.settings]),(0,n.useEffect)(()=>{var e;if(null==_?void 0:null===(e=_.round_data)||void 0===e?void 0:e.endTime){let e=Math.ceil((_.round_data.endTime-Date.now())/1e3);b(e>0?e:0)}},[null==_?void 0:null===(a=_.round_data)||void 0===a?void 0:a.endTime,U,Z]),(0,n.useEffect)(()=>{let e;return U&&!Z&&v>0&&(e=setInterval(()=>{b(e=>e<=1?(C&&!Z&&X(),0):e-1)},1e3)),()=>clearInterval(e)},[U,Z,v,C]);let V=(0,n.useMemo)(()=>{let e=Math.floor(v/60),t=v%60;return"".concat(e.toString().padStart(2,"0"),":").concat(t.toString().padStart(2,"0"))},[v]),J=async()=>{try{let e="https://query.wikidata.org/sparql?query=".concat(encodeURIComponent('\n        SELECT ?city ?cityLabel ?countryLabel ?population ?image WHERE {\n          ?city wdt:P31/wdt:P279* wd:Q515;\n                wdt:P1082 ?population;\n                wdt:P18 ?image;\n                wdt:P17 ?country.\n          FILTER(?population > 100000)\n          SERVICE wikibase:label { bd:serviceParam wikibase:language "fr,en". }\n        }\n        LIMIT 50\n        OFFSET '.concat(Math.floor(500*Math.random()),"\n      ")),"&format=json"),t=await fetch(e,{headers:{Accept:"application/json"}});return(await t.json()).results.bindings.map(e=>({name:e.cityLabel.value,country:e.countryLabel.value,population:parseInt(e.population.value,10),image:e.image.value}))}catch(e){return console.error("Error fetching cities",e),[]}},K=async()=>{if(C&&f)try{let e=await J();if(0===e.length)return;for(let t=e.length-1;t>0;t--){let a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}let t=e.slice(0,y),a=t[0],l=t.slice(1),n=Date.now()+1e3*j;await L({city:a,queue:l,endTime:n}),g("")}catch(e){console.error("Erreur lancement:",e)}},Q=async()=>{if(C&&(null==_?void 0:_.round_data))try{let e=_.round_data.queue||[];if(0===e.length){let e=await J(),t=e[Math.floor(Math.random()*e.length)],a=Date.now()+1e3*j;await R({city:t,queue:[],endTime:a});return}let t=e[0],a=e.slice(1),l=Date.now()+1e3*j;await R({city:t,queue:a,endTime:l}),g("")}catch(e){console.error("Error next round",e)}},W=()=>{if(!h.trim()||Z)return;let e=parseInt(h.replace(/\s/g,""),10);Number.isNaN(e)||P(e)},X=async()=>{if(!C||!B||!_)return;let e=B.population,t=_.answers||{},a=[];for(let n of I){var l;let s=null===(l=t[n.id])||void 0===l?void 0:l.answer;a.push({player:n.name,answer:void 0!==s?s:0,difference:void 0!==s?Math.abs(s-e):9999999999})}if(a.sort((e,t)=>e.difference-t.difference),a[0]&&a[0].difference<9999999999){let e=a[0].player,t=I.find(t=>t.name===e);t&&await D(t.id,t.score+10)}await O({..._.round_data,results:a}),await z("round_results")};(0,n.useEffect)(()=>{let e=F[F.length-1];e&&"typing"===e.type&&(e.data.player!==A&&e.data.isTyping?S(e.data.player):e.data.player===A||e.data.isTyping||S(t=>t===e.data.player?null:t))},[F,A]),(0,n.useEffect)(()=>{if(!k)return;let e=setTimeout(()=>S(null),3e3);return()=>clearTimeout(e)},[k]);let Y=(0,n.useMemo)(()=>{var e;return(null==_?void 0:null===(e=_.round_data)||void 0===e?void 0:e.results)?_.round_data.results:[]},[null==_?void 0:null===(m=_.round_data)||void 0===m?void 0:m.results]),$=(0,n.useMemo)(()=>(null==_?void 0:_.answers)?Object.keys(_.answers).map(e=>{let t=I.find(t=>t.id===e);return t?t.name:"Unknown"}):[],[null==_?void 0:_.answers,I]);return(0,l.jsx)(c.Z,{players:H,roundCount:G,maxRounds:y,timer:V,gameCode:null!=f?f:"",gameTitle:"PopulationGuessr",isHost:C,gameStarted:U,onStartGame:K,timeLeft:v,typingPlayer:k,children:(0,l.jsx)("div",{className:"flex flex-col items-center justify-center w-full max-w-4xl mx-auto gap-8",children:U?(0,l.jsxs)(l.Fragment,{children:[B&&(0,l.jsxs)("div",{className:"relative w-full max-w-4xl h-64 sm:h-96 mx-auto mb-4 rounded-xl overflow-hidden shadow-2xl",children:[(0,l.jsx)(x(),{src:B.image,alt:"City",fill:!0,className:"object-cover",priority:!0}),(0,l.jsx)("div",{className:"absolute inset-0 bg-gradient-to-t from-black/80 to-transparent pointer-events-none"}),(0,l.jsxs)("div",{className:"absolute bottom-0 left-0 right-0 p-6 text-white text-center",children:[(0,l.jsx)("h2",{className:"text-3xl font-bold mb-1",children:B.name}),(0,l.jsx)("p",{className:"text-xl text-gray-300",children:B.country})]})]}),Z?(0,l.jsxs)("div",{className:"w-full max-w-2xl bg-white/5 rounded-2xl p-8 backdrop-blur-sm border border-white/10 animate-in zoom-in-95 duration-300",children:[(0,l.jsxs)("div",{className:"text-center mb-8",children:[(0,l.jsx)("h3",{className:"text-3xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600",children:"R\xe9sultats"}),(0,l.jsxs)("div",{className:"text-5xl font-black text-white mb-2",children:[null==B?void 0:B.population.toLocaleString(),(0,l.jsx)("span",{className:"text-2xl font-normal text-gray-400 ml-2",children:"habitants"})]})]}),(0,l.jsx)("div",{className:"space-y-3 mb-8 max-h-60 overflow-y-auto custom-scrollbar",children:Y.map((e,t)=>(0,l.jsxs)("div",{className:"flex items-center justify-between p-4 rounded-xl transition-all ".concat(0===t?"bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border border-yellow-500/30":"bg-white/5 border border-white/5"),children:[(0,l.jsxs)("div",{className:"flex items-center gap-4",children:[(0,l.jsx)("div",{className:"w-8 h-8 flex items-center justify-center rounded-full font-bold ".concat(0===t?"bg-yellow-500 text-black":"bg-white/10 text-gray-400"),children:t+1}),(0,l.jsx)("span",{className:"font-medium text-lg",children:e.player})]}),(0,l.jsxs)("div",{className:"text-right",children:[(0,l.jsx)("div",{className:"font-mono font-bold text-xl",children:e.answer.toLocaleString()}),(0,l.jsx)("div",{className:"text-xs text-gray-400",children:0===e.difference?"Exact !":"Diff: ".concat(e.difference.toLocaleString())})]})]},e.player))}),C&&(0,l.jsx)(s.z,{size:"lg",className:"w-full h-14 text-lg font-bold bg-white text-black hover:bg-gray-200",onClick:Q,children:"Manche suivante"})]}):(0,l.jsxs)("div",{className:"w-full max-w-md space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,l.jsxs)("div",{className:"relative",children:[(0,l.jsx)(r.I,{type:"number",placeholder:"Population ?",value:h,onChange:e=>{g(e.target.value),q({type:"typing",data:{player:A,isTyping:e.target.value.length>0}})},onKeyDown:e=>"Enter"===e.key&&W(),className:"h-14 text-lg pr-12 text-center font-mono",autoFocus:!0}),(0,l.jsx)("div",{className:"absolute right-2 top-2 bottom-2 w-10 flex items-center justify-center text-gray-400",children:(0,l.jsx)(d.Z,{className:"w-5 h-5"})})]}),(0,l.jsx)(s.z,{size:"lg",className:"w-full h-14 text-lg font-bold shadow-lg shadow-purple-500/20 hover:shadow-purple-500/40 transition-all",onClick:W,children:"Valider"}),$.length>0&&(0,l.jsx)("div",{className:"flex flex-wrap gap-2 justify-center mt-4",children:$.map(e=>(0,l.jsxs)("div",{className:"flex items-center gap-1 bg-green-500/20 text-green-400 px-3 py-1 rounded-full text-xs",children:[(0,l.jsx)(u.Z,{className:"w-3 h-3"})," ",e]},e))})]})]}):(0,l.jsxs)("div",{className:"text-center space-y-6",children:[(0,l.jsx)("h2",{className:"text-2xl font-bold",children:"En attente du lancement..."}),C?(0,l.jsxs)("div",{className:"p-4 bg-white/10 rounded-lg backdrop-blur-sm w-full max-w-lg",children:[(0,l.jsx)("p",{className:"mb-4",children:"Configurez la partie :"}),(0,l.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-left mb-6",children:[(0,l.jsxs)("div",{className:"flex flex-col",children:[(0,l.jsx)("span",{className:"text-sm text-gray-400",children:"Rounds"}),(0,l.jsx)(r.I,{type:"number",value:y,onChange:e=>w(parseInt(e.target.value)),className:"bg-white/5 border-white/10"})]}),(0,l.jsxs)("div",{className:"flex flex-col",children:[(0,l.jsx)("span",{className:"text-sm text-gray-400",children:"Temps (s)"}),(0,l.jsx)(r.I,{type:"number",value:j,onChange:e=>N(parseInt(e.target.value)),className:"bg-white/5 border-white/10"})]})]}),(0,l.jsx)(s.z,{size:"lg",onClick:K,className:"w-full",children:"Lancer la partie"})]}):(0,l.jsxs)("div",{className:"flex flex-col items-center gap-4",children:[(0,l.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-white"}),(0,l.jsx)("p",{children:"L'h\xf4te configure la partie..."}),(0,l.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-left max-w-md mx-auto mt-4 opacity-75",children:[(0,l.jsxs)("div",{className:"flex flex-col",children:[(0,l.jsx)("span",{className:"text-sm text-gray-400",children:"Rounds"}),(0,l.jsx)("span",{className:"font-bold",children:y})]}),(0,l.jsxs)("div",{className:"flex flex-col",children:[(0,l.jsx)("span",{className:"text-sm text-gray-400",children:"Temps"}),(0,l.jsxs)("span",{className:"font-bold",children:[j,"s"]})]})]})]})]})})})}function p(e){let{params:t,searchParams:a}=e;return(0,l.jsx)(f,{roomCode:t.code,settings:a})}},4203:function(e,t,a){"use strict";a.d(t,{I:function(){return s}});var l=a(7437),n=a(1657);let s=(0,a(2265).forwardRef)((e,t)=>{let{className:a,...s}=e;return(0,l.jsx)("input",{ref:t,className:(0,n.cn)("flex h-10 w-full rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm","placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent","disabled:cursor-not-allowed disabled:opacity-50","dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:placeholder:text-slate-400",a),...s})});s.displayName="Input"},5192:function(e,t,a){"use strict";a.d(t,{r:function(){return s}});var l=a(2265),n=a(4599);function s(e,t){let[a,s]=(0,l.useState)([]),[r,o]=(0,l.useState)([]);return(0,l.useEffect)(()=>{let a=n.O.channel("room:".concat(e));return a.on("presence",{event:"sync"},()=>{s(Object.values(a.presenceState()).flat())}).on("presence",{event:"join"},e=>{let{key:t,newPresences:a}=e;console.log("Nouveau joueur:",a)}).on("presence",{event:"leave"},e=>{let{key:t,leftPresences:a}=e;console.log("Joueur parti:",a)}).on("broadcast",{event:t},e=>{let{payload:t}=e;o(e=>[...e,t])}).subscribe(async e=>{"SUBSCRIBED"===e&&await a.track({playerName:sessionStorage.getItem("playerName")||"Anonyme",gameType:t,joinedAt:new Date().toISOString()})}),()=>{a.unsubscribe()}},[e,t]),{broadcast:a=>{n.O.channel("room:".concat(e)).send({type:"broadcast",event:t,payload:a})},presence:a,messages:r}}}},function(e){e.O(0,[61,840,807,906,971,938,744],function(){return e(e.s=1484)}),_N_E=e.O()}]);